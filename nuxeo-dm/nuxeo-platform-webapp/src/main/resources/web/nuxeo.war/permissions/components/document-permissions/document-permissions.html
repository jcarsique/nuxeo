<link rel="import" href="../../../bower_components/paper-styles/paper-styles.html"></link>
<link rel="import" href="../../../bower_components/nuxeo-elements/nx-connection.html"></link>
<link rel="import" href="../../../bower_components/nuxeo-elements/nx-resource.html"></link>
<link rel="import" href="../../../bower_components/nuxeo-elements/nx-doc-resource.html"></link>
<link rel="import" href="../../../bower_components/nuxeo-elements/popup-confirm.html"></link>
<link rel="import" href="../../../bower_components/paper-button/paper-button.html"></link>
<link rel="import" href="../../../bower_components/paper-input/paper-input.html"></link>
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html"></link>
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html"></link>
<link rel="import" href="../../../permissions/components/popup-permission/popup-permission.html"></link>

<dom-module id="document-permissions">
    <template>
        <nx-doc-resource id="doc" auto="true" doc-id="{{docId}}" doc-path="{{docPath}}" response="{{doc}}"
            enrichers="extendedAcls, permissions, userVisiblePermissions"></nx-doc-resource>

        <div class="bubbleBox">
            <div class="bubbleHeader">
                <h3>Access rights defined explicitely on this folder</h3>
                <template is="dom-if" if="{{hasEverythingRight}}">
                    <popup-permission doc-id="{{doc.uid}}" user-visible-permissions="{{doc.contextParameters.userVisiblePermissions}}"
                        on-acecreated="refresh"></popup-permission>
                </template>
            </div>
            <template is="dom-if" if="{{hasLocalAcls}}">
                <div>
                    <table class="dataTable tmp-tab">
                        <tr class="tmp-tab">
                            <th class="tmp-tab">Username</th>
                            <th class="tmp-tab">Creator</th>
                            <th class="tmp-tab">Permission</th>
                            <th class="tmp-tab">Duration</th>
                            <th class="tmp-tab">Policy name</th>
                            <th class="tmp-tab">Actions</th>
                        </tr>
                        <template is="dom-repeat" items="{{localAcls}}" as="acl">
                            <template is="dom-repeat" items="{{acl.ace}}" as="ace">
                                <template is="dom-if" if="{{ace.granted}}">
                                    <tr>
                                        <td><span>{{ace.username}}</span></td>
                                        <td><span>{{ace.creator}}</span></td>
                                        <td><span>{{ace.permission}}</span></td>
                                        <td><span>{{formatDuration(ace)}}</span></td>
                                        <td><span>{{acl.name}}</span></td>
                                        <td>
                                            <template is="dom-if" if="{{hasEverythingRight}}">
                                                <popup-permission doc-id="{{doc.uid}}" ace="{{ace}}" user-visible-permissions="{{doc.contextParameters.userVisiblePermissions}}"
                                                    on-aceupdated="refresh"></popup-permission>
                                                <paper-icon-button icon="delete" on-click="localRightsDel" raised="true"></paper-icon-button>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                            </template>
                        </template>
                    </table>
                </div>
            </template>
            <template is="dom-if" if="{{!hasLocalAcls}}">
                <p class="emptyResult">There is no specific right defined here.</p>
            </template>
        </div>

        <template is="dom-if" if="{{hasInheritedAcls}}">
            <div class="bubbleBox">
                <div class="bubbleHeader">
                    <h3>Access rights coming from upper folders in the hierarchy</h3>
                    <paper-button raised="true" on-click="blockInheritance">Block inheritance</paper-button>
                </div>
                <div>
                    <table class="dataTable tmp-tab">
                        <tr class="tmp-tab">
                            <th class="tmp-tab">Username</th>
                            <th class="tmp-tab">Creator</th>
                            <th class="tmp-tab">Permission</th>
                            <th class="tmp-tab">Duration</th>
                        </tr>
                        <template is="dom-repeat" items="{{inheritedAcls}}" as="acl">
                            <template is="dom-repeat" items="{{acl.ace}}" as="ace">
                                <tr>
                                    <td><span>{{ace.username}}</span></td>
                                    <td><span>{{ace.creator}}</span></td>
                                    <td><span>{{ace.permission}}</span></td>
                                    <td><span>{{formatDuration(ace)}}</span></td>
                                </tr>
                            </template>
                        </template>
                    </table>
                </div>
            </div>
        </template>

        <template is="dom-if" if="{{!hasInheritedAcls}}">
            <div class="bubbleBox">
                <div class="bubbleHeader">
                    <h3>Access rights coming from upper folders in the hierarchy</h3>
                    <paper-button raised="true" on-click="unblockInheritance">Unblock inheritance</paper-button>
                </div>
                <div>
                    <p class="emptyResult">No rights are inherited from parent documents.</p>
                </div>
            </div>
        </template>

        <popup-confirm id="confirmation">
            <h2>Confirm ACE deletion?</h2>
        </popup-confirm>

        <nx-operation id="rmPermission" op="Document.RemovePermission" input="{{doc.uid}}" on-response="refresh"></nx-operation>
        <nx-operation id="blockOp" op="Document.BlockPermissionInheritance" input={{docId}}
            on-response="refresh"></nx-operation>
        <nx-operation id="unblockOp" op="Document.UnblockPermissionInheritance" input={{docId}}
            on-response="refresh"></nx-operation>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'document-permissions',

        properties: {
            doc: {
                type: Object,
                value: null
            },
            docId: {
                type: String,
                value: ''
            },
            docPath: {
                type: String,
                value: ''
            },
            hasEverythingRight: {
                type: Boolean,
                value: false,
                computed: 'computeEverythingRight(doc)'
            },
            hasLocalAcls: {
                type: Boolean,
                value: false,
                computed: 'computeHasLocalAcls(doc)'
            },
            hasInheritedAcls: {
                type: Boolean,
                value: false,
                computed: 'computeHasInheritedAcls(doc)'
            },
            localAcls: {
                type: Array,
                value: [],
                computed: 'computeLocalAcls(doc)'
            },
            inheritedAcls: {
                type: Array,
                value: [],
                computed: 'computeInheritedAcls(doc)'
            }
        },

        refresh: function() {
            document.querySelector('#doc').get();
        },

        formatDuration: function(ace) {
            var now = moment();
            var begin = ace.begin;
            var end = ace.end;
            var format = 'D MMM YYYY';

            if (begin !== null && end === null) {
                return (now.isAfter(begin) ? 'Since ' : 'From ') + moment(begin).format(format);
            } else if (begin === null && end !== null) {
                return 'Until ' + moment(end).format(format);
            } else if (begin !== null && end != null) {
                return (now.isAfter(begin) ? 'Since ' : 'From ') + moment(begin).format(format) + ' until ' + moment(end).format(format);
            } else {
                return '';
            }
        },

        localRightsDel: function(e, i) {
            var self = this;
            this.$.confirmation.toggle(function() {
                // Walk on data hosts in order to retrieve the 'item' property from the repeat loop item context
                var item = e.model.dataHost.dataHost.item;
                self.$.rmPermission.params = {
                    id: item.id
                };
                self.$.rmPermission.execute();
            });
        },

        computeEverythingRight: function(doc) {
            if (doc) {
                return doc.contextParameters.permissions.indexOf('Everything') !== -1;
            }
            return false;
        },

        computeHasLocalAcls: function(doc) {
            if (doc) {
                var acls = doc.contextParameters.acls;
                for (var i = 0; i < acls.length; i++) {
                    if (acls[i].name !== 'inherited' && acls.length >= 1) {
                        return true;
                    }
                }
            }
            return false;
        },

        computeHasInheritedAcls: function(doc) {
            if (doc) {
                var acls = doc.contextParameters.acls;
                for (var i = 0; i < acls.length; i++) {
                    if (acls[i].name === 'inherited') {
                        return true;
                    }
                }
            }
            return false;
        },

        computeLocalAcls: function(doc) {
            var localAcls = [];
            if (doc) {
                var acls = doc.contextParameters.acls;
                for (var i = 0; i < acls.length; i++) {
                    if (acls[i].name !== 'inherited') {
                        localAcls.push(acls[i]);
                    }
                }
            }
            return localAcls;
        },

        computeInheritedAcls: function(doc) {
            if (doc) {
                var acls = doc.contextParameters.acls;
                for (var i = 0; i < acls.length; i++) {
                    if (acls[i].name === 'inherited') {
                        return [acls[i]];
                    }
                }
            }
            return [];
        },

        blockInheritance: function() {
            this.$.blockOp.execute();
        },

        unblockInheritance: function() {
            this.$.unblockOp.execute();
        }
    });
</script>
