<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Nuxeo Quick Search"
    description="Simple gadget that does a full text search on Nuxeo"
    author="tdeprat" author_email="tdelprat@nuxeo.com">
    <Require feature="setprefs"/>
    <#include "dynamic-translations.ftl"/>
    <Require feature="dynamic-height" />
    <#include "default-oauth-prefs.ftl"/>
  </ModulePrefs>
  <#include "context-prefs.ftl"/>
  <UserPref name="savedQuery" datatype="string"></UserPref>
  <UserPref name="queryType" display_name="__MSG_label.search.queryType__"
          default_value="TEXT"  datatype="enum" required="true">
       <EnumValue value="TEXT" display_value="__MSG_label.search.TEXT__" />
       <EnumValue value="NXQL" display_value="__MSG_label.search.NXQL__" />
  </UserPref>
  <UserPref name="displayMode" display_name="__MSG_label.search.displayMode__"
          default_value="STD"  datatype="enum" required="true">
       <EnumValue value="STD" display_value="__MSG_label.search.stdMode__" />
       <EnumValue value="COMPACT" display_value="__MSG_label.search.compactMode__" />
  </UserPref>
  <Content type="html">

<![CDATA[
<html>
  <head>
  <link rel="stylesheet" type="text/css" href="${specDirectoryUrl}documentlists.css"/>
  <!-- insert JS Context -->
  ${jsContext}

  <script src="${specDirectoryUrl}default-automation-request.js"></script>
  <script src="${specDirectoryUrl}default-documentlist-display.js"></script>

  <script>
   var prefs = new _IG_Prefs(__MODULE_ID__);

   // configure Automation REST call
   var NXRequestParams={ operationId : 'Document.PageProvider',
     operationParams : { pageSize : 10},
     operationContext : {},                                                // context
     operationDocumentProperties : "common,dublincore",                    // schema that must be fetched from resulting documents
     entityType : 'documents',                                             // result type : only document is supported for now
     usePagination : true,                                                 // manage pagination or not
     displayMethod : displayDocumentList                                  // js method used to display the result
   };

   function doSearch() {
      var txt = _gel('searchPattern').value;
      runSearch(txt);
   }

   function runSearch(txt) {
      var queryType = prefs.getString("queryType");
      var displayMode = prefs.getString("displayMode");
      if ('NXQL'==queryType) {
          NXRequestParams.operationParams.query = txt;
          delete NXRequestParams.operationParams.queryParams;
      } else
      {
          NXRequestParams.operationParams.query = "SELECT * FROM Document WHERE ecm:fulltext LIKE ? AND ecm:mixinType != 'HiddenInNavigation' AND ecm:isCheckedInVersion = 0 AND ecm:currentLifeCycleState != 'deleted'";
          NXRequestParams.operationParams.queryParams = txt;
      }
      if ('COMPACT'==displayMode) {
          NXRequestParams.displayColumns = [ { type: 'builtin', field: 'icon'},
                      { type: 'builtin', field: 'titleWithLink', label: '__MSG_label.dublincore.title__'}];
      } else {
          NXRequestParams.displayColumns = [ { type: 'builtin', field: 'icon'},
                      { type: 'builtin', field: 'titleWithLink', label: '__MSG_label.dublincore.title__'},
                      { type: 'date', field: 'dc:modified', label: '__MSG_label.dublincore.modified__'},
                      { type: 'text', field: 'dc:creator', label: '__MSG_label.dublincore.creator__'} ];
      }
      doAutomationRequest(NXRequestParams);
   }

   function doSaveSearch() {
      var txt = _gel('searchPattern').value;
      prefs.set('savedQuery',txt);
      _gel("searchBox").style.display='none';
      _gel("titleBox").style.display='block';
      _gel("queryText").innerHTML=txt;
      runSearch(txt);
   }

   function loadSearch() {
      var txt = prefs.getString('savedQuery');
      if (txt) {
         runSearch(txt);
         _gel("queryText").innerHTML=txt;
         _gel("titleBox").style.display='block';
      } else {
         _gel("searchBox").style.display='block';
      }
   }

   function doEditSearch() {
      _gel("searchBox").style.display='block';
      _gel("titleBox").style.display='none';
   }

   // auto-adjust gadget height
   gadgets.util.registerOnLoadHandler(function() {loadSearch(); gadgets.window.adjustHeight();} );

  </script>
  </head>
   <body>

   <div id="searchBox" style="display:none">
   <table>
    <tr>
     <td><input type="text" name="searchPattern" id ="searchPattern"></td>
     <td><input type="button" value="__MSG_command.search__" onclick="doSearch()"/></td>
     <td><input type="button" value="__MSG_command.save__" onclick="doSaveSearch()"/></td>
    </tr>
   </table>
   </div>
   <div id="titleBox" style="display:none">
   <table>
    <tr>
     <td>__MSG_label.searchResultsFor__ <span id="queryText"> </span></td>
     <td><input type="button" value="__MSG_command.edit__" onclick="doEditSearch()"/></td>
    </tr>
   </table>
   </div>

   <#include "default-documentlist-layout.ftl"/>
   <#include "default-request-controls.ftl"/>

  </body>
</html>
]]>
  </Content>
</Module>
